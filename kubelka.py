# kubelka.py  — full 38-sample Kubelka-Munk, with verbose tracing  ───────────
import numpy as np
import logging
from colour.colorimetry import MSDS_CMFS, SpectralShape
from colour.models import RGB_COLOURSPACE_sRGB

log = logging.getLogger(__name__)

SIZE = 38
_GAMMA = 2.4

# ───────────────────────── 1.  spectral basis curves  ───────────────────────
# (exact numbers from Ronald van Wijnen, already present in your file)
BASE_SPECTRA: dict[str, np.ndarray] = {
    "W": np.array(
        [
            1.00116072718764,
            1.00116065159728,
            1.00116031922747,
            1.00115867270789,
            1.00115259844552,
            1.00113252528998,
            1.00108500663327,
            1.00099687889453,
            1.00086525152274,
            1.00069629000940,
            1.00050496114888,
            1.00030808187992,
            1.00011966602013,
            0.999952765968407,
            0.999821836899297,
            0.999738609557593,
            0.999709551639612,
            0.999731930210627,
            0.999799436346195,
            0.999900330316671,
            1.00002040652611,
            1.00014478793658,
            1.00025997903412,
            1.00035579697089,
            1.00042753780269,
            1.00047623344888,
            1.00050720967508,
            1.00052519156373,
            1.00053509606896,
            1.00054022097482,
            1.00054272816784,
            1.00054389569087,
            1.00054448212151,
            1.00054476959992,
            1.00054489887762,
            1.00054496254689,
            1.00054498927058,
            1.00054499699300,
        ],
        dtype=np.float32,
    ),
    "C": np.array(
        [
            0.970585001322962,
            0.970592498143425,
            0.970625348729891,
            0.970786806119017,
            0.971368673228248,
            0.973163230621252,
            0.976740223158765,
            0.981587605491377,
            0.986280265652949,
            0.989949147689134,
            0.992492701538420,
            0.994145680405256,
            0.995183975033212,
            0.995756750110818,
            0.995912818286710,
            0.995606157834528,
            0.994597600961854,
            0.992215715492370,
            0.986236452783249,
            0.967943337264541,
            0.891285004244943,
            0.536202477862053,
            0.154108119001878,
            0.057457509322893,
            0.031534987310701,
            0.022263392008634,
            0.018202284149244,
            0.016299055973264,
            0.015365623933461,
            0.014911156873398,
            0.014695433989824,
            0.014596414671772,
            0.014547015669966,
            0.014522877189950,
            0.014512034111897,
            0.014506694093983,
            0.014504450731448,
            0.014503800946464,
        ],
        dtype=np.float32,
    ),
    "M": np.array(
        [
            0.990673557319988,
            0.990671524961979,
            0.990662582353421,
            0.990618107644795,
            0.990451480878710,
            0.989871081400204,
            0.988286608759640,
            0.984290692797504,
            0.973934905625306,
            0.941817838460145,
            0.817390326195156,
            0.432472805065729,
            0.138453978258870,
            0.053734721694003,
            0.029217499667323,
            0.021313651750859,
            0.020134953018114,
            0.024132309628066,
            0.037223614522363,
            0.076050655270660,
            0.205375471942399,
            0.541268903460439,
            0.815841685086486,
            0.912817704123976,
            0.946339830166962,
            0.959927696331991,
            0.966260595230312,
            0.969325970058424,
            0.970854536721399,
            0.971605066528128,
            0.971962769757392,
            0.972127272274509,
            0.972209417745812,
            0.972249577678424,
            0.972267621998742,
            0.972276509462150,
            0.972280243306874,
            0.972281324826560,
        ],
        dtype=np.float32,
    ),
    "Y": np.array(
        [
            0.021052337178931,
            0.021056462751741,
            0.021074617869504,
            0.021164905844875,
            0.021502795727250,
            0.022673879904156,
            0.025823564969363,
            0.033487938563985,
            0.051906966374031,
            0.100749014833473,
            0.239129899706847,
            0.534804312272748,
            0.797807578643030,
            0.911449894067384,
            0.953797963004507,
            0.971241615465429,
            0.979303123807588,
            0.983380119507575,
            0.985461246567755,
            0.986435046976605,
            0.986738250670141,
            0.986617882445032,
            0.986277776758643,
            0.985860592444056,
            0.985474927676210,
            0.985176934765558,
            0.984971574014181,
            0.984846303415712,
            0.984775351811199,
            0.984738066625265,
            0.984719648311765,
            0.984711023391939,
            0.984706683300676,
            0.984704554393091,
            0.984703596309370,
            0.984703124077552,
            0.984702925615090,
            0.984702868122795,
        ],
        dtype=np.float32,
    ),
    "R": np.array(
        [
            0.031560573777721,
            0.031552071833015,
            0.031514821551366,
            0.031331804498270,
            0.030672985772553,
            0.028648047698961,
            0.024645040704571,
            0.019296075366365,
            0.014206661222056,
            0.010294260887861,
            0.007619146052181,
            0.005898041083542,
            0.004823324778171,
            0.004229874835063,
            0.004059917129934,
            0.004353369559468,
            0.005343442597020,
            0.007691720101046,
            0.013596979573654,
            0.031697544266112,
            0.107861196355249,
            0.463812603168704,
            0.847055405272011,
            0.943185409393918,
            0.968862150696558,
            0.978030667473603,
            0.982043643854306,
            0.983923623718707,
            0.984845484154382,
            0.985294275814596,
            0.985507295219825,
            0.985605071539837,
            0.985653849933578,
            0.985677685033883,
            0.985688391806122,
            0.985693664690031,
            0.985695879848205,
            0.985696521463762,
        ],
        dtype=np.float32,
    ),
    "G": np.array(
        [
            0.009556074755421,
            0.009558158012085,
            0.009567324544459,
            0.009612912629735,
            0.009783709040184,
            0.010378622705871,
            0.012002645237857,
            0.016097772147392,
            0.026706190223168,
            0.059555544018588,
            0.186039826532826,
            0.570579820116159,
            0.861467768400292,
            0.945879089767658,
            0.970465486474305,
            0.978413630284450,
            0.979589031411224,
            0.975533536908632,
            0.962288755397813,
            0.923121574513120,
            0.793434018943111,
            0.459270135902429,
            0.185574103666303,
            0.088177495995537,
            0.054363022876670,
            0.040628844706072,
            0.034221520431697,
            0.031118579095697,
            0.029570889833613,
            0.028810873934893,
            0.028448627132460,
            0.028282030172473,
            0.028198837649024,
            0.028158165534204,
            0.028139891021639,
            0.028130890166581,
            0.028127108680582,
            0.028126013361210,
        ],
        dtype=np.float32,
    ),
    "B": np.array(
        [
            0.979404752502014,
            0.979400706843130,
            0.979382903470261,
            0.979294364945594,
            0.978963014608570,
            0.977814466694043,
            0.974724321133836,
            0.967198482343973,
            0.949079657530575,
            0.900850128940977,
            0.763150445462240,
            0.465922171649319,
            0.201263280451005,
            0.087752441341962,
            0.045717679329168,
            0.028470605052184,
            0.020527176756985,
            0.016530279231021,
            0.014513510721286,
            0.013600350863769,
            0.013360425876957,
            0.013548894314568,
            0.013959435636699,
            0.014443425575357,
            0.014885444062141,
            0.015225429699975,
            0.015459284818021,
            0.015601802648596,
            0.015682487128194,
            0.015724876436062,
            0.015745810878412,
            0.015755612335023,
            0.015760544396491,
            0.015762963751528,
            0.015764052562911,
            0.015764589232951,
            0.015764814777265,
            0.015764880114962,
        ],
        dtype=np.float32,
    ),
}
_BASE = np.stack([BASE_SPECTRA[k] for k in ("W", "C", "M", "Y", "R", "G", "B")])

# ───────────────────────── 2.  CIE CMFs (38 points)  ────────────────────────
shape = SpectralShape(380, 750, 10)
_CMF = (
    MSDS_CMFS["CIE 1931 2 Degree Standard Observer"]
    .copy()
    .align(shape)
    .values.T.astype(np.float32)
)  # 3 × 38

# ───────────────────────── 3.  sRGB ↔ XYZ matrices  ─────────────────────────
_RGB_XYZ = RGB_COLOURSPACE_sRGB.matrix_RGB_to_XYZ.astype(np.float32)
_XYZ_RGB = RGB_COLOURSPACE_sRGB.matrix_XYZ_to_RGB.astype(np.float32)


# ───────────────────────── 4.  helper functions  ────────────────────────────
def _uncompand(v: np.ndarray) -> np.ndarray:
    m, out = v > 0.04045, np.empty_like(v, np.float32)
    out[m] = ((v[m] + 0.055) / 1.055) ** _GAMMA
    out[~m] = v[~m] / 12.92
    return out


def _compand(v: np.ndarray) -> np.ndarray:
    m, out = v > 0.0031308, np.empty_like(v, np.float32)
    out[m] = 1.055 * np.power(v[m], 1 / _GAMMA) - 0.055
    out[~m] = v[~m] * 12.92
    return out


_ks = lambda R: (1 - R) ** 2 / (2 * R)
_km = lambda ks: 1 + ks - np.sqrt(ks * ks + 2 * ks)


# ───────────────────── 5.  sRGB → spectral reflectance  ─────────────────────
def _srgb_to_R(rgb: np.ndarray) -> np.ndarray:
    lin = _uncompand(rgb)
    w = lin.min()
    lin -= w
    c, m, y = min(lin[1], lin[2]), min(lin[0], lin[2]), min(lin[0], lin[1])
    r = max(0, min(lin[0] - lin[2], lin[0] - lin[1]))
    g = max(0, min(lin[1] - lin[2], lin[1] - lin[0]))
    b = max(0, min(lin[2] - lin[1], lin[2] - lin[0]))
    coeffs = np.array([w, c, m, y, r, g, b], np.float32)[:, None]  # 7×1
    R = (_BASE * coeffs).sum(0)
    return np.clip(R, 1e-6, 1)


# ───────────────────── 6.  spectral reflectance → sRGB  ─────────────────────
def _R_to_srgb(R: np.ndarray) -> np.ndarray:
    xyz = _CMF @ R
    lin = _XYZ_RGB @ xyz
    srgb = _compand(lin)
    return np.clip(srgb, 0, 1)


# ───────────────────── 7.  public mixer with logging  ───────────────────────
def km_mix(rgb_a: np.ndarray, rgb_b: np.ndarray, t: float) -> np.ndarray:
    log.debug("KM  t=%.3f  A=%s  B=%s", t, rgb_a, rgb_b)

    Ra, Rb = _srgb_to_R(rgb_a), _srgb_to_R(rgb_b)
    # log.debug("Ra=%s", Ra.round(4))
    # log.debug("Rb=%s", Rb.round(4))

    ks = _ks(Ra) * (1 - t) + _ks(Rb) * t
    # log.debug("K/S mix=%s", ks.round(4))

    Rmix = _km(ks)
    rgb = _R_to_srgb(Rmix)

    # log.debug("→ sRGB=%s\n", rgb.round(4))
    return rgb
